# ?? Fluxo Atual: Ao Clicar em "Atas" no NavBar

## ?? Fluxo Atual (ANTES - Direto com Service)

```
???????????????????????????????????????????????????????????????????
?  BROWSER / USUÁRIO                                              ?
???????????????????????????????????????????????????????????????????
                  ?
                  ? Clica em "Atas" no NavBar
                  ? (linha 70-72 em _Layout.cshtml)
                  ?
???????????????????????????????????????????????????????????????????
?  MVC - AtaController.cs                                         ?
?  ????????????????????????????????????????????????????????????????
?  ? public IActionResult Index()                                ??
?  ? {                                                           ??
?  ?     var lista = _service.GetAll();  // IAtaService         ??
?  ?     var vms = _mapper.Map<List<AtaViewModel>>(lista);      ??
?  ?     return View(vms);                                       ??
?  ? }                                                           ??
?  ????????????????????????????????????????????????????????????????
?                                                                 ?
?  ? USO DIRETO DE SERVIÇO (não passa pela API)                 ?
?     - Usa IAtaService injetado via DI                          ?
?     - Acessa banco de dados diretamente                        ?
?     - Sem autenticação JWT (usa ASP.NET Identity)              ?
???????????????????????????????????????????????????????????????????
                  ?
                  ?
???????????????????????????????????????????????????????????????????
?  SERVICE LAYER - AtaService.cs                                  ?
?  ????????????????????????????????????????????????????????????????
?  ? public List<Ata> GetAll()                                   ??
?  ? {                                                           ??
?  ?     return context.Atas.AsNoTracking().ToList();            ??
?  ? }                                                           ??
?  ????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????
                  ?
                  ?
???????????????????????????????????????????????????????????????????
?  DATABASE - MySQL (CondosmartContext)                           ?
?  ????????????????????????????????????????????????????????????????
?  ? SELECT * FROM atas;                                         ??
?  ????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????
                  ?
                  ? Retorna Atas
                  ?
???????????????????????????????????????????????????????????????????
?  View/Razor Page - Views/Ata/Index.cshtml                       ?
?  ????????????????????????????????????????????????????????????????
?  ? @foreach (var ata in Model)                                 ??
?  ? {                                                           ??
?  ?     <tr>                                                    ??
?  ?         <td>@ata.Titulo</td>                                ??
?  ?         <td>@ata.DataReuniao</td>                           ??
?  ?     </tr>                                                   ??
?  ? }                                                           ??
?  ????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????
                  ?
                  ? Renderiza HTML
                  ?
???????????????????????????????????????????????????????????????????
?  BROWSER - Exibe Página de Atas                                 ?
???????????????????????????????????????????????????????????????????
```

---

## ?? Fluxo NOVO com API (DEPOIS - Usando a API criada)

```
???????????????????????????????????????????????????????????????????
?  BROWSER / USUÁRIO                                              ?
???????????????????????????????????????????????????????????????????
                  ?
                  ? Clica em "Atas" no NavBar
                  ? (linha 70-72 em _Layout.cshtml)
                  ?
???????????????????????????????????????????????????????????????????
?  MVC - ReservaController.cs (NOVO PADRÃO)                       ?
?  ????????????????????????????????????????????????????????????????
?  ? private readonly IHttpClientFactory _httpClientFactory;     ??
?  ?                                                             ??
?  ? public async Task<IActionResult> Index()                    ??
?  ? {                                                           ??
?  ?     var client = CreateClient();                            ??
?  ?     var response = await client.GetAsync("api/atas");       ??
?  ?     var atas = await response.Content                       ??
?  ?         .ReadFromJsonAsync<List<AtaViewModel>>();         ??
?  ?     return View(atas ?? new List<AtaViewModel>());         ??
?  ? }                                                           ??
?  ????????????????????????????????????????????????????????????????
?                                                                 ?
?  ? USA HttpClientFactory (padrão Reserva)                      ?
?     - Não injeta IAtaService                                   ?
?     - Faz requisição HTTP à API                                ?
?     - Usa JWT Token para autenticação                          ?
???????????????????????????????????????????????????????????????????
                  ?
                  ? HTTP GET: api/atas
                  ?
???????????????????????????????????????????????????????????????????
?  API LAYER - AtasController.cs (? JÁ CRIADA)                   ?
?  ????????????????????????????????????????????????????????????????
?  ? [Authorize(Roles = "Admin,Sindico,Morador")]               ??
?  ? [HttpGet]                                                   ??
?  ? public ActionResult<IEnumerable<AtaViewModel>> GetAll()     ??
?  ? {                                                           ??
?  ?     var atas = _service.GetAll();                           ??
?  ?     return Ok(_mapper.Map<List<AtaViewModel>>(atas));      ??
?  ? }                                                           ??
?  ????????????????????????????????????????????????????????????????
?                                                                 ?
?  ? Com autenticação JWT e autorização por Role                ?
???????????????????????????????????????????????????????????????????
                  ?
                  ?
???????????????????????????????????????????????????????????????????
?  SERVICE LAYER - AtaService.cs                                  ?
?  ????????????????????????????????????????????????????????????????
?  ? public List<Ata> GetAll()                                   ??
?  ? {                                                           ??
?  ?     return context.Atas.AsNoTracking().ToList();            ??
?  ? }                                                           ??
?  ????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????
                  ?
                  ?
???????????????????????????????????????????????????????????????????
?  DATABASE - MySQL (CondosmartContext)                           ?
?  ????????????????????????????????????????????????????????????????
?  ? SELECT * FROM atas;                                         ??
?  ????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????
                  ?
                  ? Retorna JSON
                  ?
???????????????????????????????????????????????????????????????????
?  JSON Response (application/json)                               ?
?  ????????????????????????????????????????????????????????????????
?  ? [                                                           ??
?  ?   {                                                         ??
?  ?     "id": 1,                                                ??
?  ?     "titulo": "Assembléia Ordinária",                       ??
?  ?     "dataReuniao": "2024-01-15",                            ??
?  ?     "nomeCondominio": "Condomínio Beija Flor",              ??
?  ?     ...                                                     ??
?  ?   }                                                         ??
?  ? ]                                                           ??
?  ????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????
                  ?
                  ? Desserializa JSON
                  ?
???????????????????????????????????????????????????????????????????
?  MVC - Converte JSON para List<AtaViewModel>                    ?
???????????????????????????????????????????????????????????????????
                  ?
                  ?
???????????????????????????????????????????????????????????????????
?  View/Razor Page - Views/Ata/Index.cshtml                       ?
???????????????????????????????????????????????????????????????????
                  ?
                  ? Renderiza HTML
                  ?
???????????????????????????????????????????????????????????????????
?  BROWSER - Exibe Página de Atas                                 ?
???????????????????????????????????????????????????????????????????
```

---

## ?? Comparação de Fluxos

| Aspecto | AtaController (ATUAL) | ReservaController (NOVO PADRÃO) |
|--------|----------------------|----------------------------------|
| **Injeção de Dependência** | `IAtaService` (direto) | `IHttpClientFactory` |
| **Acesso aos Dados** | Direto ao banco via Service | Via HTTP/API |
| **Autenticação** | ASP.NET Identity | JWT Bearer Token |
| **Mapeamento** | AutoMapper local (MVC) | AutoMapper na API + retorno JSON |
| **Responsabilidade** | Controller + Service juntos | API (separação de conceitos) |
| **Escalabilidade** | Acoplado ao MVC | Desacoplado e reutilizável |
| **Status Code** | IActionResult direto | HTTP Status Codes padronizados |

---

## ?? Recomendação

Para manter a **consistência arquitetural**, você pode:

### Opção 1: Manter o Fluxo Atual (RECOMENDADO agora)
- ? AtaController usa `IAtaService` diretamente
- ? Simples e direto
- ? Sem latência de rede
- ?? Menos flexível para futuros consumidores externos

### Opção 2: Migrar para o Padrão Reserva (Futuro)
- ? Padrão de API separada
- ? Reutilizável por outros clientes (web, mobile, desktop)
- ? Segurança com JWT
- ?? Adiciona latência de rede
- ?? Requer refatoração do controller

---

## ?? Endpoints da API ATAS Disponíveis

```
GET    /api/atas             ? Retorna todas as atas
GET    /api/atas/{id}        ? Retorna uma ata específica
POST   /api/atas             ? Cria uma nova ata
PUT    /api/atas/{id}        ? Atualiza uma ata
DELETE /api/atas/{id}        ? Deleta uma ata
```

**Autenticação:** Requer `Authorization: Bearer <JWT_TOKEN>`
**Roles Permitidas:** Admin, Sindico, Morador

---

## ?? Exemplo de Requisição HTTP

```bash
# Login (obter token)
POST https://localhost:7070/api/auth/login
Content-Type: application/json

{
  "email": "sindico@condosmart.com",
  "password": "Senha123!"
}

# Resposta
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "email": "sindico@condosmart.com",
  "roles": ["Sindico"],
  "expiration": "2024-01-20T12:30:00Z"
}

# Buscar Atas (com token)
GET https://localhost:7070/api/atas
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Resposta
[
  {
    "id": 1,
    "titulo": "Assembléia Ordinária",
    "dataReuniao": "2024-01-15",
    "nomeCondominio": "Condomínio Beija Flor",
    "nomeSindico": "João Silva"
  }
]
```

---

## ? Status da Implementação

- ? **AtasController** criado com sucesso
- ? **AtaViewModel** criado com sucesso
- ? **AtaProfile** criado com sucesso
- ? **Serviço IAtaService** já existia
- ? **Navegação no MVC** já aponta para Ata
- ? **Migração do MVC para usar API** (opcional - não feita)

A API está **100% funcional** e pronta para ser consumida!
